# ClickHouse Best Practices - Maintainer Guide

This directory contains the ClickHouse Best Practices skill for AI agents.

## Directory Structure

```
clickhouse-best-practices/
├── SKILL.md              # Skill definition (loaded by agents)
├── AGENTS.md             # Compiled guide (generated by build script)
├── metadata.json         # Version, organization, abstract
├── README.md             # This file (maintainer guide)
└── rules/
    ├── _sections.md      # Section metadata
    ├── _template.md      # Template for new rules
    └── *.md              # Individual rule files
```

## Adding a New Rule

1. Create a new markdown file in `rules/` using the naming convention:
   ```
   {section-prefix}-{descriptive-name}.md
   ```

   Section prefixes:
   - `schema-` for Schema Design rules
   - `query-` for Query Optimization rules
   - `table-` for Table Engines rules
   - `index-` for Indexing Strategies rules
   - `materialized-` for Materialized Views rules
   - `cluster-` for Distributed Operations rules
   - `ops-` for Operations & Monitoring rules
   - `performance-` for Performance Tuning rules

2. Use the template from `rules/_template.md` as a starting point.

3. Include YAML frontmatter with:
   ```yaml
   ---
   title: Rule Title
   impact: CRITICAL | HIGH | MEDIUM-HIGH | MEDIUM | LOW-MEDIUM | LOW
   impactDescription: Optional (e.g., "10-100× query speedup")
   tags: clickhouse, query-optimization, etc.
   ---
   ```

4. Structure the rule with:
   - Brief explanation
   - **Incorrect:** code example showing the anti-pattern
   - **Correct:** code example showing the best practice
   - Additional context or trade-offs
   - Reference links (optional)

5. Ensure all SQL examples are valid ClickHouse SQL.

## Impact Levels

Choose the appropriate impact level for your rule:

- **CRITICAL**: Affects query performance by 10× or more, or causes serious data issues
- **HIGH**: Affects query performance by 2-10×, or significantly impacts scalability
- **MEDIUM-HIGH**: Notable performance improvements (25-100%), or important for specific workloads
- **MEDIUM**: Modest performance improvements (10-25%), or helpful for maintainability
- **LOW-MEDIUM**: Small performance improvements (5-10%), or nice-to-have optimizations
- **LOW**: Minor improvements or edge cases

## Build Process

After adding or editing rules, run the build process:

```bash
cd ../../packages/clickhouse-best-practices-build

# Install dependencies (first time only)
bun install

# Validate rule structure
bun run validate

# Validate SQL syntax (downloads ClickHouse binary if needed)
bun run validate-sql

# Check internal links
bun run check-links

# Build AGENTS.md
bun run build

# Upgrade version (increments metadata.json and SKILL.md)
bun run build-agents -- --upgrade-version
```

## Contributing Guidelines

- Keep rules focused and actionable
- Use real SQL that can be executed (avoid pseudo-code)
- Include performance metrics when possible (e.g., "10× speedup", "reduces I/O by 50%")
- Reference official ClickHouse documentation where relevant
- Test SQL examples before committing
- Follow the existing style and structure

## File Naming Conventions

Good examples:
- `query-use-prewhere.md`
- `schema-column-order.md`
- `table-choose-merge-tree.md`
- `index-skip-index-bloom-filter.md`

Bad examples:
- `PrewhereOptimization.md` (use kebab-case)
- `query.md` (too generic)
- `rule1.md` (not descriptive)
