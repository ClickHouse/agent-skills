name: Daily External Links Check

on:
  schedule:
    - cron: '0 9 * * 1-5'  # 9 AM UTC, Monday-Friday
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-external-links:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: packages/clickhouse-best-practices-build

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v1.2.2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check external links
        run: bun run check-external-links

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@70cd7be8e40a46e8b0eced40b0de447bdb42f68e # v1.27.0
        with:
          webhook-url: ${{ secrets.RELEASE_SLACK_WEBHOOK }}
          payload: |
            {
              "text": "❌ External Links Check Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ External Links Check Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                }
              ]
            }
